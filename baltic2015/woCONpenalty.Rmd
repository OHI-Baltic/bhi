---
title: "Recalculating CON and CW without Penalty"
output: html_document
---

<br>

## Comparing scores for assessment year 2014 
### With vs Without CON Penalty Factor

This script tests the effect on scores of including/excluding the contaminants penalty factor, which is applied based on the  proportion of known hazardous substances are not monitored.

<br>

---

### Set-up, Data, and Functions

**Using the same set-up/data read-in/defined helper functions etc as in `wFis2019data.Rmd`**

```{r setup, include=FALSE}
library(tidyverse)
library(ohicore)
library(httr)
library(zoo)

dir <- here::here("baltic2015")
```

```{r function for configuring and getting scores}
## based on 'calculate_scores.R' 
## but dont want to save scores.csv each time, and want some other results returned as well...
calculate_bhi <- function(directory, funRpath, lyrcsv, calcforYr = 2014, writeAll = FALSE){
  
  if(file.exists(file.path(directory, "conf", "functions.R"))){
    funs_current <- scan(
      file.path(directory, "conf", "functions.R"), 
      what = "character", 
      sep = "\n", 
      blank.lines.skip = FALSE
    )
  } else {funs_current <- NULL}
  if(file.exists(file.path(directory, "layers.csv"))){
    lyrs_current <- read_csv(file.path(directory, "layers.csv"), col_types = cols())
  } else {lyrs_current <- NULL}
  
  ## configure functions and layers.csv as needed for desired calculations
  funs_use <- scan(
    funRpath, 
    what = "character", 
    sep = "\n", 
    blank.lines.skip = FALSE
  )
  write_lines(funs_use, file.path(directory, "conf", "functions.R"), sep = "\n")
  
  ## configure layers: when lyrcsv is a valid filepath read it, just write if a df
  if(is.character(lyrcsv)){
    if(file.exists(lyrcsv)){
      lyrs_use <- read_csv(lyrcsv, col_types = cols())
    } else {stop("specified layers.csv file does not exist")}
  } else {lyrs_use <- lyrcsv}
  write_csv(lyrs_use, file.path(directory, "layers.csv"))
  
  ## use ohicore functions to calculate scores
  # setwd(directory)
  conf = ohicore::Conf("conf")
  ## check that scenario layers files in \layers folder match layers.csv registration. Layers files not modified.
  ohicore::CheckLayers("layers.csv", "layers", flds_id=conf$config$layers_id_fields)
  layersobj <- ohicore::Layers("layers.csv", "layers")
  scenario_years <- calcforYr # select corresponding data year to use for pressures and resilience
  layersobj$data$scenario_year <- scenario_years
  assign("layers", layersobj, envir = .GlobalEnv) # ohicore needs 'layers' in global not function env...
  scores <- CalculateAll(conf, layers) # calculate scenario scores
  
  if(!writeAll){
    if(!is.null(lyrs_current) & !is.null(funs_current)){
      ## ohicore calculations requires files in scenario folder
      ## so if we dont want things overwritten (just want scores), actually need to write back to previous...
      write_lines(funs_current, file.path(directory, "conf", "functions.R"), sep = "\n")
      write_csv(lyrs_current, file.path(directory, "layers.csv"))
    }
  } else {
    ## if we do want everything saved, write scores also
    write_csv(scores, file.path(directory, "scores.csv"))
  }

  return(list(scores = scores, layerscsv = lyrs_use, functionsR = funs_use))
}
```

```{r get relevant layers data from github, results="hide", warning=FALSE, message=FALSE}

if(!file.exists(file.path(dir, "layers"))){dir.create(file.path(dir, "layers"))}

## copy bhi-1.0-archive baltic2015 layers
req <- GET("https://api.github.com/repos/OHI-Science/bhi-1.0-archive/git/trees/draft?recursive=1")
stop_for_status(req)
filelist <- unlist(lapply(content(req)$tree, "[", "path"), use.names = FALSE) %>% 
  grep(pattern = "baltic2015/layers/", value = TRUE) %>% 
  str_extract("/[a-zA-Z0-9_-]+.csv|/[a-zA-Z0-9_-]+$") %>% 
  str_remove_all(".csv")
lyrcsv2015 <- read_csv(file.path(dir, "compare", "layers2015.csv"), col_types = cols())
lapply(
  c(
    intersect(lyrcsv2015$filename, str_remove(filelist, "/") %>% paste0(".csv")), 
    "eco_trend_scores_BHI2015.csv" # random capitalization causes issue...
  ),
  function(x){
    read_csv(
      paste0("https://raw.githubusercontent.com/OHI-Science/bhi-1.0-archive/draft/baltic2015/layers/", unlist(x)),
      col_types = cols() ) %>% 
      write_csv(file.path(dir, "layers", unlist(x) %>% str_replace_all("_BHI2015", "_bhi2015")))
  }
)

## copy new FIS goal layers from 2019 data prep over from the bhi-prep v2019 layers folder
req <- GET("https://api.github.com/repos/OHI-Science/bhi-prep/git/trees/master?recursive=1")
stop_for_status(req)
filelist <- unlist(lapply(content(req)$tree, "[", "path"), use.names = FALSE) %>% 
  grep(pattern = "layers/v2019/", value = TRUE) %>% 
  str_extract("[a-z0-9_]+.csv")
lapply(
  filelist,
  function(x){
    read_csv(
      paste0("https://raw.githubusercontent.com/OHI-Science/bhi-prep/master/layers/v2019/", unlist(x)),
      col_types = cols()) %>% 
      rename(rgn_id = region_id) %>% 
      write_csv(file.path(dir, "layers", unlist(x)))
  }
)
new_fis_lyrs <- c("fis_ffmsy_bhi2019.csv", "fis_bbmsy_bhi2019.csv", "fis_landings_bhi2019.csv")
file.exists(file.path(dir, "layers", new_fis_lyrs))
```

<br>

---

### Calculate Scores without CON Penalty

**Using a revised functions.R file (`compare/functions2019_cwNew.R`) with updated FIS and CON goal functions**

```{r configure layerscsv with new fisheries v2019 data and cod penalty layer, results="hide", warning=FALSE, message=FALSE}

lyrs_csv_fis2019 <- read_csv(file.path(dir, "compare", "layers2015.csv")) %>%
  mutate(
    filename = ifelse(
      layer == "fis_bbmsy", "fis_bbmsy_bhi2019.csv",
      ifelse(layer == "fis_ffmsy", "fis_ffmsy_bhi2019.csv",
             ifelse(layer == "fis_landings", "fis_landings_bhi2019.csv", filename)
      )
    ),
    fld_val_num = ifelse(
      layer == "fis_bbmsy", "value",
      ifelse(layer == "fis_ffmsy", "value", fld_val_num)
    ),
    fld_value = ifelse(
      layer == "fis_bbmsy", "value",
      ifelse(layer == "fis_ffmsy", "value", fld_value)
    ))

cod_penalty_lyr <- data.frame(
  targets = "FIS", layer = "fis_cod_penalty", name = "Cod Condition Penalty Factor", 
  description = "Proportion of Cod 20-40cm with Fultons K less than 0.8", 
  fld_value = "penalty_factor", units = "proportion", 
  filename = "fis_cod_penalty_bhi2019.csv", clip_n_ship_disag = NA, clip_n_ship_disag_description = NA, 
  layer_gl = NA, path_in = NA, rgns_in = NA, fld_id_num = "rgn_id", fld_id_chr = NA, 
  fld_category = NA, fld_year = NA, fld_val_num = "penalty_factor", fld_val_chr = NA, 
  file_exists = NA, year_min = NA, year_max = NA, 
  val_min = NA, val_max = NA, val_0to1 = NA, flds_unused = NA, 
  flds_missing = NA, rows_duplicated = NA, num_ids_unique = NA, data_na = NA
)

## functions2019_cwNew.R contains v2019 functions.R with revised FIS and CON functions
## FIS function revised so F-scores piecewise eqn aligns better were slope and line segments meet
## CON function revised to calculate scores without penalty factor
scores_noCONpenalty <- calculate_bhi(
  directory = dir, 
  funRpath = file.path(dir, "compare", "functions2019_cwNew.R"), 
  lyrcsv = rbind(lyrs_csv_fis2019, cod_penalty_lyr)
)

## original with new FIS data and function but still with CON penalty
## i.e. to isolate effect of changing CON penalty
scoresOriginal <- calculate_bhi(
  directory = dir, 
  funRpath = file.path(dir, "compare", "functions2019.R"), 
  lyrcsv = rbind(lyrs_csv_fis2019, cod_penalty_lyr)
)
```

```{r compariosn, results="hide", warning=FALSE, message=FALSE}
compareScores <- scoresOriginal$scores %>% 
  rename(scoresPenalized = score) %>% 
  left_join(
    scores_noCONpenalty$scores, 
    by = c("goal", "dimension", "region_id")
  ) %>% 
  mutate(diffs = score - scoresPenalized)

compareScores <- compareScores %>%
  filter(region_id %in% 0:42) %>% 
  filter(goal %in% c("CON", "CW",  "Index")) %>% 
  filter(dimension %in% c("score", "status", "future"))
```

```{r view comparison plot, echo=FALSE, warning=FALSE, message=FALSE}
ggplot(compareScores) +
  geom_col(aes(x = region_id, y = diffs), width = 0.7) +
  facet_grid(vars(dimension), vars(goal))

tmpplot <- ggplot(compareScores) +
  geom_col(aes(x = region_id, y = score), width = 0.7) +
  facet_grid(vars(dimension), vars(goal))

plotly::ggplotly(tmpplot)
```
