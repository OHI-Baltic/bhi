---
title: "Regions"
output: html_document
---

---

```{r setup, echo = F, warning = FALSE, message = F}
source("_site.R")
```

Regions are the fundamental spatial units of analysis for the Ocean Health Index. Scores are calculated for each region individually and then combined (with an offshore area-weighted average) to produce scores for the entire Baltic Sea.  **There are 42 BHI regions in the Baltic Sea,** created by intersecting exclusive economnic zones (EEZs) with the Baltic Sea subbasins.

<br>

```{r, echo = FALSE}

## check config.R for spatial plotting variables/objects
config <- readr::read_lines(file.path(bhi_gh_raw, "master/baltic/conf/config.R")) %>% 
  grep(pattern = "^#{1,2}\\s", value = TRUE, invert = TRUE) %>% 
  grep(pattern = "[a-zA-Z0-9].*", value = TRUE) %>% 
  str_replace_all(pattern = "\\\"", replacement = "'")

if(!any(str_detect(config, pattern = "geojson <- "))){
  stop(sprintf("missing geojson path variable at %s/conf/config.R", dir_scenario_gh))
}

## read spatial
geojson <- file.path(
    bhi_gh_raw, 
    "master",
    config %>% 
      grep(pattern = "geojson <- ", value = TRUE) %>% 
      str_extract("[a-zA-Z0-9_/]+.geojson"))

rgns <- geojsonio::geojson_read(geojson, what = "sp")
if("rgn_nam" %in% names(rgns@data) & !"rgn_name" %in% names(rgns@data)){
  rgns@data = rgns@data %>% mutate(rgn_name = rgn_nam)
}
```

---

```{r, out.width = '100%'}
## create and render leaflet map
leaflet::leaflet(data = rgns) %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  setView(18, 59, zoom = 5) %>%
  addPolygons(
    layerId = ~rgn_id,
    stroke = TRUE, opacity = 0.5, weight = 2, fillOpacity = 0.5, smoothFactor = 0.5,
    color = ~colorNumeric("#6fa0b4", rgns$rgn_id)(rgn_id)) %>%
  addPolygons(
    layerId = ~rgn_id,
    popup = paste("<h5><strong>", "Region:", "</strong>",
                  rgns@data$rgn_nam,"</h5>",
                  "<h5><strong>", "Region BHI ID:", "</strong>", rgns@data$rgn_id, "</h5>"),
    fillOpacity = 0,
    stroke = FALSE
  ) %>% 
  htmlwidgets::onRender("
  function(el, t) {
    var defaultStyle = {
      // stroke, ie polygon border
        opacity:     0.5,
        weight:      2,
      // fill, ie polygon interior
        fillOpacity: 0.5,
    };
    var highlightStyle = {
      // stroke, ie polygon border
        opacity:     0.9,
        weight:      6,
      // fill, ie polygon interior
        fillOpacity: 0.9,
    };
    var myMap = this;
    var layers = myMap._layers;
    for(var i in layers) {
      var layer = layers[i];
      if(layer.label) {
        layer.on('mouseover',
          function(e) {
            this.setStyle(highlightStyle);
            // this.bringToFront();
        });
        layer.on('mouseout',
          function(e) {
            this.setStyle(defaultStyle);
            // this.bringToBack();
        });
      }
    }
  }")
```

---
