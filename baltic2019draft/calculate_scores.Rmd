---
title: "Calculate Baltic OHI scores, v2019"
output: html_document
---

R code to calculate BHI scores using the `ohicore` package.

----

## Install R packages

Run this code chunk one time only to install packages you don't already have. This is like wiring a building for electricity.

```{r install packages, eval=FALSE}
## install packages from R community
install.packages("tidyverse")
install.packages("zoo")
install.packages("here")
install.packages("devtools")
install.packages("httr")
install.packages("tools")
install.packages("tibble")

## install the ohicore package from OHI team
devtools::install_github("ohi-science/ohicore")
```


## Load R packages

Run these every time you calculate scores so that you will have libraries available to you. This is like turning on the lights in a building. Additionally, you will set the working directory to your scenario folder.

```{r setup, eval=FALSE}
## SET BHI ASSESSMENT DIRECTORY HERE
dir_assess <- here::here("baltic2019draft")

## created and maintained by OHI team at NCEAS
## https://github.com/OHI-Science/ohicore
library(ohicore)

## source common.R, setup.R, calculating.R to load libraries, identify directories and functions
## github or directory paths can be revised in the setup.R script
source(here::here("R", "setup.R"))
source(here::here("R", "common.R"))

## set the working directory to a filepath we all have, dir_assess assigned in setup.R
setwd(dir_assess)

## at this point, double check that all bhi-prep changes have been pushed to github!
## make sure files in bhi-prep 'layers' folder are the ones we want for calculating scores!
```


## Configure Toolbox

Run this chunk each time you calculate scores to ensure that all layer files in your repo are up-to-date.

```{r configure layers, eval=FALSE}
source(here::here("R", "reconfiguring.R"))

## read layers.csv so proper layers can be copied from bhi-prep
lyrs <- readr::read_csv(file.path(dir_assess, "layers.csv"))

## copy layers from the bhi-prep, via github master branch, assessment-specific layer folder
## the function 'copy_lyrs_from_bhiprep' is defined in reconfiguring.R script
copy_lyrs_from_bhiprep(dir_assess, copy_layers = list(lyrs$filename))
```

```{r configure functions, eval=FALSE}
funs <- c(
  "fis_2019.R", "mar_2019.R", "fp_2019.R", "np_2019.R",
  "con_2019.R", 
  # "eut_2019.R", "tra_2019.R",
  # "bd_2019.R", "ico_2019.R", "lsp_2019.R", "sp_2019.R",
  "finalize_scores.R"
)
configure_functions(dir_assess, test_funs_list = funs)
```

```{r configure scenario data years, eval=FALSE}
## will use ohi layers object to check data years in layers
layers <- ohicore::Layers("layers.csv", "layers")
include_scenario_years <- 2005:2019

## run this to revise the scenario_data_years.csv, or change manually e.g. using execl
scenario_data_years <- file.path(dir_assess, "conf", "scenario_data_years.csv") %>% 
  read_csv() %>% 
  filter(layer_name %in% layers$meta$layer)
scenario_data_years <- scenario_data_include(
  scenario_data_years,
  scenario_yrs = include_scenario_years,
  new_lyrs = setdiff(layers$meta$layer, unique(scenario_data_years$layer_name))
)
updated <- do.call(rbind, lapply(layers$meta$layer,  function(x){
  
  lyrdata <- layers$data[[x]]
  datayrs <- sort(unique(lyrdata$year), decreasing = TRUE)
  datayrs <- datayrs[1:length(include_scenario_years)]
  
  scenario_data_align(
    scenario_data_years, 
    lyr_name = x,
    data_yrs = datayrs,
    scenario_yrs = include_scenario_years,
    approach = "intervals with maximum step 2 years"
  ) %>% filter(layer_name == x)
}))
write_csv(updated, file.path(dir_assess, "conf", "scenario_data_years.csv"))
```


## Calculate and save scores

Run this chunk to calculate and save scores as `scores` object and as `scores.csv`. Functions from ohicore (`ohicore::`) will check your repo's files to make sure you have registered layers properly, etc. It will create `conf` and `layers` objects that will be used to calculate scores, based on current `functions.R`, `layers.csv`, etc. These functions will not modify layers files.

```{r calculate scores, eval=FALSE}
## scenario years to calculate scores for in this assessment
scenario_years <- 2013:2014

## usually we use excel to edit these files, 
## so, need to make sure for ohicore funcs etc they are comma delim. not semicolons
lapply(
  list(
    file.path(dir_assess, "layers.csv"),
    file.path(dir_assess, "conf", "scenario_data_years.csv")
  ),
  function(x){semicolon_to_comma(x, remove_na_cols = TRUE, overwrite = TRUE)}
)

## load scenario configuration
conf <- ohicore::Conf("conf")
## check that scenario layers files in the \layers folder match layers.csv registration
ohicore::CheckLayers("layers.csv", "layers", flds_id=conf$config$layers_id_fields)
## reload checked layers for ohicore to access
layers <- ohicore::Layers("layers.csv", "layers")


## calculate scores for all scenario years and save as scores.csv
scorelist <- do.call(rbind, lapply(scenario_years, function(yr){
  layers$data$scenario_year <- yr
  cbind(
    ohicore::CalculateAll(conf, layers),
    year = yr
  )
}))

## save the scores
readr::write_csv(scorelist, sprintf("%s/scores.csv", dir_assess), na = "")
```

---

#### Session Info

**devtools::session_info() at time scores were calculated.**

